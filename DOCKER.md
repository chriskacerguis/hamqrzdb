# Docker Deployment Guide

This guide explains how to run the HamQRZDB API using Docker and nginx.

## Prerequisites

- Docker and Docker Compose installed
- Data must be in the `./output/` directory (generated by `process_uls.py`)
- The Docker container uses a **bind mount** to serve data from the host

## Quick Start

### Build and Run with Docker Compose (Recommended)

```bash
# Make sure you have data in the output directory
ls output/

# Build and start the container
docker-compose up -d

# Check if it's running
docker-compose ps

# View logs
docker-compose logs -f

# Stop the container
docker-compose down
```

The API will be available at `http://localhost:8080`

### Build and Run with Docker

```bash
# Build the image (small, contains only nginx config)
docker build -t hamqrzdb .

# Run the container with bind mount
docker run -d \
  -p 8080:80 \
  -v "$(pwd)/output:/usr/share/nginx/html:ro" \
  --name hamqrzdb \
  hamqrzdb

# Check if it's running
docker ps

# View logs
docker logs -f hamqrzdb

# Stop and remove
docker stop hamqrzdb
docker rm hamqrzdb
```

## Testing the API

```bash
# Test with a valid callsign
curl http://localhost:8080/v1/KJ5DJC/json/test

# Test with a non-existent callsign (should return NOT_FOUND)
curl http://localhost:8080/v1/BADCALL/json/test

# Health check
curl http://localhost:8080/health
```

## Expected Responses

### Valid Callsign
```json
{
  "hamdb": {
    "version": "1",
    "callsign": {
      "call": "KJ5DJC",
      "class": "G",
      ...
    },
    "messages": {
      "status": "OK"
    }
  }
}
```

### Invalid Callsign (NOT_FOUND)
```json
{
  "hamdb": {
    "version": "1",
    "callsign": {
      "call": "NOT_FOUND",
      "class": "NOT_FOUND",
      ...
    },
    "messages": {
      "status": "NOT_FOUND"
    }
  }
}
```

## URL Format

The API follows the HamDB format:
```
/v1/{callsign}/json/{app_name}
```

Examples:
- `/v1/KJ5DJC/json/myapp`
- `/v1/W1AW/json/test`
- `/v1/K2ABC/json/lookup`

The `{app_name}` parameter is ignored but required for compatibility.

## How It Works

1. **URL Rewriting**: nginx extracts the callsign from the URL
2. **File Lookup**: Converts callsign to file path (e.g., `KJ5DJC` â†’ `/K/J/5/KJ5DJC.json`)
3. **Response**: 
   - If file exists: Returns the callsign data
   - If file doesn't exist: Returns NOT_FOUND JSON with HTTP 200

## Production Deployment

### With Reverse Proxy (Recommended)

Use this nginx configuration as an upstream behind another nginx or Caddy server that handles SSL:

```nginx
# Example nginx reverse proxy config
server {
    listen 443 ssl http2;
    server_name lookup.kj5djc.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Updating Data

The container uses a bind mount, so data updates are **live** without needing to restart:

```bash
# Run daily updates
./update-daily.sh

# Or run full rebuild
./process_uls.py --full

# Changes are immediately available - no container restart needed!
```

The container serves files directly from `./output/` on the host, keeping the Docker image small (~10MB) and making updates instant.

### Image Size Benefits

- **Without bind mount** (copying data): ~2-3 GB image
- **With bind mount** (current setup): ~10 MB image
- Updates are instant (no rebuild/restart required)
- Easy to backup (just backup `./output/` directory)

### Environment Variables

You can customize the nginx configuration by editing `nginx.conf` before building.

## Monitoring

### Check Container Health
```bash
# Container status
docker-compose ps

# Resource usage
docker stats hamqrzdb

# Logs
docker-compose logs -f
```

### nginx Access Logs
```bash
# View access logs
docker-compose exec hamqrzdb tail -f /var/log/nginx/access.log

# View error logs
docker-compose exec hamqrzdb tail -f /var/log/nginx/error.log
```

## Troubleshooting

### Container Won't Start
```bash
# Check logs
docker-compose logs

# Verify files exist
ls -la output/
ls -la 404.json
ls -la nginx.conf
```

### Port Already in Use
Change the port in `docker-compose.yml`:
```yaml
ports:
  - "9090:80"  # Use port 9090 instead
```

### 404 Not Returning JSON
```bash
# Verify 404.json exists
docker-compose exec hamqrzdb cat /usr/share/nginx/html/404.json

# Check nginx config
docker-compose exec hamqrzdb nginx -t
```

### Reload nginx Configuration
```bash
# After changing nginx.conf
docker-compose exec hamqrzdb nginx -s reload

# Or rebuild
docker-compose up -d --build
```

## Performance Tuning

The current configuration is optimized for:
- Gzip compression for JSON responses
- Long cache times (24 hours) for callsign data
- No caching for 404/NOT_FOUND responses
- CORS enabled for all origins

For high-traffic deployments, consider:
- Adding nginx caching layer
- Using multiple container replicas with load balancer
- Using CDN in front of the server

## Security Notes

- CORS is enabled for all origins (`*`)
- No authentication is required
- Health check endpoint at `/health` for monitoring
- Hidden files (`.git`, etc.) are denied by default
